<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<title>有种你接我呀！</title>
	<script type="text/javascript" src="../lib/createjs-2015.05.21.min.js"></script>
	<script type="text/javascript" src="../lib/ndgmr.Collision.js"></script>
	<style type="text/css">
		*{
			margin: 0;
			padding: 0;
		}
		body{
			overflow: hidden;
		}
		canvas#myGame{
			background-image: url("../images/gameBg.png");
			background-size: cover;
		}
	</style>
</head>
<body scroll="no">
<!--  -->
	<canvas id="myGame"></canvas>
	<script type="text/javascript">

		var assetsPath = "../audio/";
		var sounds = [
			{src: "bg.wav", id: 1},
			{src: "get.wav", id: 2},
			{src: "lost.wav", id: 3}
		];
		var bgMusic;
		createjs.Sound.alternateExtensions = ["mp3"];
		createjs.Sound.addEventListener("fileload", createjs.proxy(soundLoaded, this));
		createjs.Sound.registerSounds(sounds, assetsPath);
		function soundLoaded(){
			createjs.Sound.play(1);
			bgMusic = createjs.Sound.play(1);
		}

		// 获取设备的宽和高
		var device = {
			width: function(){
				return document.documentElement.clientWidth;
			},
			height: function(){
				return document.documentElement.clientHeight;
			}
		}

		document.body.addEventListener("touchmove", function (event) {
			event.preventDefault();
		}, false);
		window.onresize = function(){
			canvas.width = device.width();
			canvas.height = device.height();
		}

		var canvas = document.getElementById("myGame");
		canvas.width = device.width();
		canvas.height = device.height();
		// mygame
		var stage = new createjs.Stage('myGame');
		var dragger = new createjs.Container();
		var longBoat = new createjs.Bitmap("../images/lz.png");

		var timeline = new createjs.Text("1:00", "36px Arial", "#ff7700");
		var time = 59;
		var maxScore = new createjs.Text("1000", "36px Arial", "#ff7700");
		var score = new createjs.Text("0", "36px Arial", "#00F");
		var yourScore = 0;

		createjs.Touch.enable(stage);
		stage.setBounds(0, 0, device.width(), device.height());
		dragger.addChild(longBoat);
		longBoat.scaleX = 0.6;
		longBoat.scaleY = 0.6;
		longBoat.setBounds(0, 0, 250, 100);
		dragger.setBounds(0, 0, 250, 100);
		dragger.x = (stage.getBounds().width -dragger.getBounds().width) / 2;
		dragger.y = stage.getBounds().height -dragger.getBounds().height
		
		timeline.x = 2;
		timeline.y = 1;

		score.x = device.width() - 180;
		score.y = 1;

		maxScore.x = device.width()-80;
		maxScore.y = 1;

		stage.addChild(timeline);
		stage.addChild(score);
		stage.addChild(maxScore);

		stage.addChild(dragger);
		dragger.on("pressmove",function(evt) {
				evt.currentTarget.x = evt.stageX - 125;
				stage.update();   
		});

		var timelineT = setInterval(function(){
			if(time <= 0){
				clearInterval(timelineT);
				
			}
			if(time >= 10){
				timeline.text = "0:"+time;
			}
			else{
				timeline.text = "0:0"+time;
			}
			--time;
		},1000);

		var whichOne = parseInt(Math.random()*10);
		var addTcrp = setInterval(function(){
			var tcrp = new createjs.Bitmap("../images/zz/"+whichOne+".png");
			tcrp.x = device.width() * Math.random();
			tcrp.y = 0;
			stage.addChild(tcrp);
			stage.update();
			whichOne = parseInt(Math.random()*9 + 1);
			if(100 >= createjs.Ticker.framerate){
				createjs.Ticker.framerate += 2;
			}
		},800);
		createjs.Ticker.addEventListener("tick", handleTick);
		createjs.Ticker.framerate = 30;
		var ly = [5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5];
		var lx = [5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5];
		function handleTick(event) {
			for(var i = 4; i < stage.getNumChildren(); i++){
				var tcrpC = stage.getChildAt(i);
				tcrpC.x += lx[i] + lx[i] * Math.random();
				tcrpC.y += ly[i];
				if(tcrpC.x < 0){
					tcrpC.x = 0;
					lx[i] = -lx[i];
				}
				if(tcrpC.x > device.width()){
					tcrpC.x = device.width();
					lx[i] = -lx[i];
				}
				if(tcrpC.y >= (device.height())){
					stage.removeChild(tcrpC);
					createjs.Sound.play(3);
				}
				var intersection = ndgmr.checkRectCollision(tcrpC,longBoat);
				if(intersection){
					if((intersection.x - longBoat.x > 100) && (intersection.x - longBoat.x < 200) && (intersection.y > device.height() - 50) ){
					
						console.log(intersection);
						console.log(longBoat.y);
						stage.removeChild(tcrpC);
						yourScore += 5 + 5 * Math.random();
						score.text = parseInt(yourScore);
						createjs.Sound.play(2);

						if(bgMusic.playState == createjs.Sound.PLAY_FINISHED){
							createjs.Sound.play(1);
						}
					}
				}
			}
			stage.update();
		}
	</script>
</body>
</html>